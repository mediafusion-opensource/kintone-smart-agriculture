(() => {
    'use strict';
    
    const APP_ID = kintone.app.getId();

    function showLoading() {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loadingDiv';
        loadingDiv.style.position = 'fixed';
        loadingDiv.style.top = '0';
        loadingDiv.style.left = '0';
        loadingDiv.style.width = '100%';
        loadingDiv.style.height = '100%';
        loadingDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        loadingDiv.style.display = 'flex';
        loadingDiv.style.justifyContent = 'center';
        loadingDiv.style.alignItems = 'center';
        loadingDiv.style.zIndex = '1000';

        loadingDiv.innerHTML = '<div style="border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid #3498db; width: 60px; height: 60px; animation: spin 2s linear infinite;"></div>';
    
        const style = document.createElement('style');
        style.type = 'text/css';
        style.innerHTML = `@keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }`;
        document.head.appendChild(style);

        document.body.appendChild(loadingDiv);
    }


    function hideLoading() {
        const loadingDiv = document.getElementById('loadingDiv');
        if (loadingDiv) {
            document.body.removeChild(loadingDiv);
        }
    }

kintone.events.on('app.record.index.show', async (event) => {
    showLoading();  

    const now = new Date();
    const formattedTime = now.getTime();  

    
    const previousUpdateTime = localStorage.getItem('lastUpdateTime');

    if (previousUpdateTime && (formattedTime - previousUpdateTime < 5000)) {
        localStorage.removeItem('lastUpdateTime'); 
        hideLoading(); 
        return event;  
    }

    try {
        const records = (await getWarehouseRecords()).records;
        const todayDate = new Date().toISOString().split('T')[0];
        const shippingRecords = await getShippingRecords(todayDate);
        const sortingRecords = await getSortingRecordsBeforeToday(todayDate);
        let expectRecords = [];

        for (let record of records) {
            const productId = record['商品'].value; 
            const arrivalArray = record['入荷'].value;
            let totalRemainingStock = 0;
            let totalShippedQuantity = 0;
            let totalStockBeforeToday = 0;

            // Get `productRowId` from `ルックアップキー`
            arrivalArray.forEach(item => {
                const lookupKey = item.value['ルックアップキー'].value;
                const [, productRowId] = lookupKey.split('|');
                item.productRowId = productRowId; // Assign `productRowId` to each item in `入荷履歴`
            });

            // Calculate the total number of classifications from filtered classification records
            const totalSortedQuantity = calculateTotalSortedQuantityFromRecords(sortingRecords, productId, arrivalArray);

            // Retrieves the inventory from 入荷履歴 of yesterday
            const totalStockInBeforeToday = getTotalStockInBeforeToday(record, todayDate);

            // Get the amount that was exported from the classification before today
            const totalShippedFromSorting = calculateAdditionalQuantityFromShipping(record, shippingRecords);

            // Add up today's stock imports
            const totalStockInToday = getTotalStockInToday(record, todayDate, sortingRecords);

            // Calculate the total number of classifications
            const updatedQuantity = totalSortedQuantity + totalStockInBeforeToday + totalShippedFromSorting + totalStockInToday;
            totalRemainingStock += updatedQuantity;
            totalShippedQuantity += calculateShippedQuantityForProductBeforeToday(record, shippingRecords);

            // Calculate the total inventory up to the previous day
            arrivalArray.forEach(item => {
                const arrivalDate = item.value['入荷日'].value;
                if (arrivalDate < todayDate) {
                    totalStockBeforeToday += Number(item.value['入荷数'].value);
                }
            });
            totalStockBeforeToday = totalStockBeforeToday - calculateShippedQuantityForProductBeforeToday(record, shippingRecords) - calculateAdditionalQuantityFromShipping(record, shippingRecords);

            // Updates the log with newly calculated values
            const tmpRecord = {
                'id': record['$id'].value,
                'record': {
                    '前日までの選別': {
                        value: totalRemainingStock
                    },
                    '前日までの出荷数': {
                        value: totalShippedQuantity
                    },
                    '前日までの在庫数': {
                        value: totalStockBeforeToday
                    }
                }
            };
            expectRecords.push(tmpRecord);
        }

        console.log('expectRecords', expectRecords);

        // Update all records at once
        const body = {
            'app': INVENTORY_MANAGEMENT_APP_ID,
            'records': expectRecords
        };
        await kintone.api(kintone.api.url('/k/v1/records.json', true), 'PUT', body);

       // Store successful update time into localStorage
        localStorage.setItem('lastUpdateTime', formattedTime);

        // Reload the page after updating
        location.reload(); 

    } catch (error) {
        console.error('Error during calculation:', error);
    } 
});

kintone.events.on('app.record.detail.show', async function(event) {
        showLoading();

    const now = new Date();
    const formattedTime = now.getTime();  // Get the time as timestamp

    // Check if there has been a previous update time
    const previousUpdateTime = localStorage.getItem('lastUpdateTime');
    
    // Compare the time if the difference is less than 5 seconds then return it
    if (previousUpdateTime && (formattedTime - previousUpdateTime < 5000)) {
        console.log('Đã cập nhật gần đây, không cần tính toán lại');
        localStorage.removeItem('lastUpdateTime');  // Delete the stored value so it won't affect the next time
        hideLoading()
        return event;  
    }

            const record = event.record;
            const records = (await getWarehouseRecords()).records;
            const todayDate = new Date().toISOString().split('T')[0];
            const shippingRecords = await getShippingRecords(todayDate);
            const sortingRecords = await getSortingRecordsBeforeToday(todayDate)
              const productId = record['商品'].value; 
                const arrivalArray = record['入荷'].value;
                let totalRemainingStock = 0;
                let totalShippedQuantity = 0;
                let totalStockBeforeToday = 0;

               // Get `productRowId` from `ルックアップキー`
                arrivalArray.forEach(item => {
                    const lookupKey = item.value['ルックアップキー'].value;
                    const [, productRowId] = lookupKey.split('|');
                    item.productRowId = productRowId; // Assign `productRowId` to each item in `入荷履歴`
                });

                // Calculate the total number of classifications from filtered classification records
                const totalSortedQuantity = calculateTotalSortedQuantityFromRecords(sortingRecords, productId, arrivalArray);

                // Retrieves the inventory from 入荷履歴 of yesterday
                const totalStockInBeforeToday = getTotalStockInBeforeToday(record, todayDate);

                // Get the amount that was exported from the classification before today
                const totalShippedFromSorting = calculateAdditionalQuantityFromShipping(record, shippingRecords);

                // Add up today's stock imports
                const totalStockInToday = getTotalStockInToday(record, todayDate,sortingRecords );

               // Calculate the total number of classifications
                const updatedQuantity = totalSortedQuantity + totalStockInBeforeToday + totalShippedFromSorting + totalStockInToday;
                totalRemainingStock += updatedQuantity;
                totalShippedQuantity += calculateShippedQuantityForProductBeforeToday(record, shippingRecords);

                // Calculate the total inventory up to the previous day
                arrivalArray.forEach(item => {
                    const arrivalDate = item.value['入荷日'].value;
                    if (arrivalDate < todayDate) {
                        totalStockBeforeToday += Number(item.value['入荷数'].value);
                    }
                });
                totalStockBeforeToday = totalStockBeforeToday - calculateShippedQuantityForProductBeforeToday(record, shippingRecords) - calculateAdditionalQuantityFromShipping(record, shippingRecords);
                // Updates the log with newly calculated values
                const tmpRecord = {
                    'app': APP_ID,
                    'id': record['$id'].value,
                    'record': {
                        '前日までの選別': {
                            value: totalRemainingStock
                        },
                        '前日までの出荷数': {
                            value: totalShippedQuantity
                        },
                        '前日までの在庫数': {
                            value: totalStockBeforeToday
                        }
                    }
                };
                    kintone.api(kintone.api.url('/k/v1/record', true), 'PUT', tmpRecord, function(resp) {
                           localStorage.setItem('lastUpdateTime', formattedTime);
                          location.reload();
                      }, function(error) {
                          console.error('error', error);
                      });
  
  return event;
});
    // The function takes the total amount from the filtered classification records
    function calculateTotalSortedQuantityFromRecords(sortingRecords, productId, arrivalArray) {
        let totalSortedQuantity = 0;

        // Browse pre-filtered classification logs today
        sortingRecords.forEach(record => {
            const selectionData = record['選別データ'].value;

            // Browse each product in 選別データ
            selectionData.forEach(item => {
                const productRowId = item.id; // Product ID in 選別データ
                const productInSorting = item.value['商品'].value;

                if (productInSorting === productId || arrivalArray.some(arrival => arrival.productRowId === productRowId)) {
                    totalSortedQuantity += Number(item.value['数量'].value);
                }
            });
        });

        return totalSortedQuantity;
    }

    // Get list of records sorted by date
    async function getSortingRecordsBeforeToday(todayDate) {
        return new Promise((resolve, reject) => {
            const query = `選別日付 < "${todayDate}"`;
            kintone.api(kintone.api.url('/k/v1/records.json', true) + '?app=' + SORTING_MANAGEMENT_APP_ID + '&query=' + encodeURIComponent(query), 'GET', {})
                .then(resp => resolve(resp.records))
                .catch(error => reject(error));
        });
    }

   // The function takes the total amount imported from 入荷履歴 of yesterday
    function getTotalStockInBeforeToday(record, todayDate) {
        let totalStockIn = 0;
        const arrivalArray = record['入荷'].value;
        arrivalArray.forEach(item => {
            const arrivalDate = item.value['入荷日'].value;
            if (arrivalDate < todayDate) {
                totalStockIn += Number(item.value['入荷数'].value);
            }
        });
        return totalStockIn;
    }

   // The function takes today's inventory amount
  function getTotalStockInToday(record, todayDate, sortingRecords) {
      let totalStockInToday = 0;
      const arrivalArray = record['入荷'].value;

     arrivalArray.forEach(item => {
         const arrivalDate = item.value['入荷日'].value;
  
          if (arrivalDate === todayDate) {
              const lookupKey = item.value['ルックアップキー'].value;
             const [, productRowId] = lookupKey.split('|'); 
  
              const existsInSortingRecords = sortingRecords.some(sortingRecord => {
                  const selectionData = sortingRecord['選別データ'].value;
                  return selectionData.some(selectionItem => selectionItem.id === productRowId);
              });

             if (existsInSortingRecords) {
                totalStockInToday += Number(item.value['入荷数'].value);
              }
         }
     });

     return totalStockInToday;
}


    //Retrieves the list of records exported by date
    async function getShippingRecords(todayDate) {
        return new Promise((resolve, reject) => {
            const query = `出荷日付 < "${todayDate}"`;
            kintone.api(kintone.api.url('/k/v1/records.json', true) + '?app=' + SHIPPING_AND_DELIVERY_APP_ID + '&query=' + encodeURIComponent(query), 'GET', {})
                .then(resp => resolve(resp.records))
                .catch(error => reject(error));
        });
    }

    // Function for calculating additional amount from shipping records if available
    function calculateAdditionalQuantityFromShipping(record, shippingRecords) {
        let additionalQuantity = 0;
        shippingRecords.forEach(shippingRecord => {
            const productList = shippingRecord['商品リスト'].value;
            productList.forEach(productItem => {
                const shippingProductId = productItem.value['商品'].value;
                if (shippingProductId === record['商品'].value) {
                    additionalQuantity += Number(productItem.value['選別数量'].value);
                }
            });
        });
        return additionalQuantity;
    }

    // Function to calculate the amount exported for the specific product up to the previous day
    function calculateShippedQuantityForProductBeforeToday(warehouseRecord, shippingRecords) {
        let totalShippedQuantity = 0;
        shippingRecords.forEach(shippingRecord => {
            const productList = shippingRecord['商品リスト'].value;
            productList.forEach(productItem => {
                const shippingProductId = productItem.value['商品'].value;
                if (shippingProductId === warehouseRecord['商品'].value) {
                    totalShippedQuantity += Number(productItem.value['出荷数量'].value);
                }
            });
        });
        return totalShippedQuantity;
    }

    // Retrieves the list of records from the app store
    function getWarehouseRecords() {
        return new Promise((resolve, reject) => {
            kintone.api(kintone.api.url('/k/v1/records.json', true), 'GET', { app: APP_ID, query: 'limit 100 offset 0' })
                .then(resp => resolve(resp))
                .catch(error => reject(error));
        });
    }
})();
