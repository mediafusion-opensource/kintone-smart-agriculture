/*
  Calendar.js
*/
class MF_AgriCalendar {
  constructor(elementId, events, options) {
    this.CONST_VIEWS = {
      'oneRowWeek': 'oneRowWeek',
      'oneRowMonth': 'oneRowMonth',
      'oneRowDate': 'oneRowDate',
      'dayGridMonth': 'dayGridMonth'
    }
    this.CONST_LANGUAGES = {
      'ja': {
        'WEEK': '週',
        'MONTH': '月',
        'TODAY': '今日',
        'PREVIOUS': '前の',
        'NEXT': '次'
      },
      'en': {
        'WEEK': 'Week',
        'MONTH': 'Month',
        'TODAY': 'Today',
        'PREVIOUS': 'Previous',
        'NEXT': 'Next'
      }
    }
    this.LANGUAGE = {};
    this.elementId = elementId;
    this.events = events || []; 
    this.datesArray = [];
    this.options = options || {};
    // check options property
    if (!this.options.initView) this.options.initView = 'oneRowWeek';
    if (!this.options.views) this.options.views = {
        [this.CONST_VIEWS['oneRowWeek']]: 1,
        [this.CONST_VIEWS['oneRowMonth']]: 1,
        [this.CONST_VIEWS['dayGridMonth']]: 1
    }
    if (!this.options.offset) this.options.offset = 0;
    if (!this.options.locale) this.options.locale = 'en';
    if (!this.options.isAutoGeneratedDate) this.options.isAutoGeneratedDate = true;
    if (!this.options.hightLightToday) this.options.hightLightToday = true;
    // with locale
    moment.locale(this.options.locale);
    this.LANGUAGE = this.CONST_LANGUAGES[this.options.locale];
    
    this.updateEvents = this.updateEvents.bind(this);
    this.updateOptions = this.updateOptions.bind(this);
    this.getOffsetDays = this.getOffsetDays.bind(this);
    this.renderEventItem = () => {};
    this.renderEventItemDetail = () => {};
    this.renderInfoDate = undefined;
    this.afterRender = () => {};
    this.addEvent = undefined // () => {};
    this.updateEvent = undefined // () => {};
    this.removeEvent = undefined // () => {};
    this.needUpdateEvents = () => {};
    
    this.calendarElm = jQuery(`#${this.elementId}`);
    this.focusDateElm = undefined;
    this.currentPopupDetailEvent = undefined;
    this.render();
  }
  onShowEventDetail(eventId){
    const eventElm = jQuery(`#${this.elementId}-table div[data-event-id="${eventId}"]`)[0];
    const pos = eventElm.getBoundingClientRect();
    const event = this.events.find(o => o.eventId == eventId);
    jQuery(".mf-calendar-detail-event-popup").remove();
    
    const divContainer = jQuery('<div class="d-flex flex-row justify-content-end">');
    if (this.updateEvent) divContainer.append(`<div type="button" class="detail-event-btn-control" data-edit-event-id="${event.eventId}"><i class="fa fa-pencil"></i></div>`);
    if (this.removeEvent) divContainer.append(`<div type="button" class="detail-event-btn-control" data-remove-event-id="${event.eventId}"><i class="fa fa-trash"></i></div>`);
    divContainer.append(`<div type="button" class="detail-event-btn-control close-event-detail-popup"><i class="fa fa-times"></i></div>`);
    
    const popupDetail = jQuery('<div>').addClass('mf-calendar-detail-event-popup').html(divContainer);
    popupDetail.append(this.renderEventItemDetail(event));
    
    const width = jQuery(window).width();
    const height = jQuery(window).height();
    let max = 0;
    let maxH = pos['left'] > width - pos['right'] ? 'left' : 'right';
    let maxV = pos['top'] > height - pos['bottom'] ? 'top' : 'bottom';
    jQuery("body").append(popupDetail);
    
    if (maxH == 'left' && maxV == 'top'){
      popupDetail.css({
        top: pos['top'] - popupDetail.height() - 5,
        left: pos['left'] - 100
      });  
    }
    else if (maxH == 'left' && maxV == 'bottom'){
      popupDetail.css({
        top: pos['bottom'],
        left: pos['left'] - 100
      });  
    } 
    else if (maxH == 'right' && maxV == 'top'){
      popupDetail.css({
        top: pos['top'] - popupDetail.height() - 5,
        left: pos['left']
      });  
    } 
    else if (maxH == 'right' && maxV == 'bottom'){
      popupDetail.css({
        top: pos['bottom'],
        left: pos['left']
      });  
    } 
    
    this.currentPopupDetailEvent = popupDetail;
    const MFCalendar = this;
    jQuery(`.close-event-detail-popup`).click(function(){
      jQuery(MFCalendar.currentPopupDetailEvent).remove();
    })
    jQuery(`.mf-calendar-detail-event-popup div[data-edit-event-id]`).click(function(event){
      const eventId = jQuery(this).data("edit-event-id");
      MFCalendar.updateEvent(eventId);
    })
    jQuery(`.mf-calendar-detail-event-popup div[data-remove-event-id]`).click(function(event){
      const eventId = jQuery(this).data("remove-event-id");
      MFCalendar.removeEvent(eventId);
    })
    jQuery(document).on('mousedown touchstart touchmove touchend', function(event) {
      if (jQuery(event.target).closest('.mf-calendar-detail-event-popup').length === 0) {
        jQuery(MFCalendar.currentPopupDetailEvent).remove();
      }
    });
  }
  onFocusDate(element){
    if (this.focusDateElm){
      jQuery(this.focusDateElm).removeClass('mf-calendar-focus-date-bg');
    }
    this.focusDateElm = jQuery(element);
    if (!element) return; 
    jQuery(element).addClass('mf-calendar-focus-date-bg');
    
    const dateValue = jQuery(this.focusDateElm).data("date");
    const groupByIndex = jQuery(this.focusDateElm).parent().data("groupby-index");
    if (this.addEvent) this.addEvent({element: jQuery(this.focusDateElm), date: dateValue, groupByValue: this?.options?.groupBy?.rowData?.[groupByIndex]})
  }
  updateDatesArray(datesArray){
    this.datesArray = datesArray;
    this.render();
  }
  updateEvents(newEvents){
    this.events = newEvents;
    this.render();
  }
  updateOptions(newOptions){
    if (!newOptions) newOptions = {};
    let needUpdateEvents = false;
    for (const key of Object.keys(newOptions)){
      this.options[key] = newOptions[key];
      if (key === 'offset'){
        needUpdateEvents = true;
      }
    }
    this.render();
    if (needUpdateEvents) this.needUpdateEvents();
  }
  isSpecialHoliday(date){
    const locale = this.options.locale;
    if (locale === 'ja'){
      return JapaneseHolidays.isHoliday(new Date(date))
    }
    return false;
  }
  renderEventOfDate(date, eventDate){
    const currentDate = moment(date);
    const initView = this.options.initView;
    let htmlElm = `<td class="mf-calendar-date" data-date="${currentDate.format('YYYY-MM-DD HH:mm')}" data-day="${currentDate.day()}">
    <div class="mf-calendar-event-container">`;
    htmlElm += `<div class="d-flex justify-content-between" data-day="${currentDate.day()}">
      <div>${initView === this.CONST_VIEWS.dayGridMonth ? currentDate.format('MM/DD') : ''}</div>
    </div>`;
    if (initView === this.CONST_VIEWS.oneRowDate){
      for (let item of eventDate){
        htmlElm += `<div class="mf-calendar-event-container-date-mode" data-event-id="${item.eventId}">` + this.renderEventItem(item) 
        + `</div>`;
      }
      htmlElm += `</div></td>`;
    }
    else {
      for (let item of eventDate.slice(0, 3)){
         htmlElm += `<div data-event-id="${item.eventId}">`
          + this.renderEventItem(item)
          + `</div>`;
      }
      htmlElm += `</div>`;
      if (eventDate.length - 3 > 0){
        htmlElm += `<div class="show-full-display-event" data-date="${currentDate.format('YYYY-MM-DD HH:mm')}">その他${eventDate.length - 3}件`;
        htmlElm += '<div class="full-display-events position-absolute">';
        for (let item of eventDate.slice(3, eventDate.length)){
          htmlElm += `<div data-event-id="${item.eventId}">`
          + this.renderEventItem(item)
          + `</div>`
        }
        htmlElm += `</div>`;
      }
      htmlElm += `</td>`;
    }
    
    return htmlElm;
  }
  getOffsetDays() {
    const initView = this.options.initView;
    const offset = this.options.offset;
    if (initView === this.CONST_VIEWS.oneRowWeek){
      const currentDate = moment();
      const firstDayOfWeek = currentDate.clone().startOf('week').add(offset, 'weeks');
      const days = [];
      for (let i = 0; i < 7; i++) {
          days.push(firstDayOfWeek.clone().add(i, 'days'));
      }
      return days;
    }
    else if (initView === this.CONST_VIEWS.oneRowMonth){
      const currentDate = moment();
      const firstDayOfMonth = currentDate.clone().add(offset, 'months').startOf('month');
      const lastDayOfMonth = currentDate.clone().add(offset, 'months').endOf('month');
      const days = [];
      while (firstDayOfMonth.isSameOrBefore(lastDayOfMonth)) {
          days.push(firstDayOfMonth.clone());
          firstDayOfMonth.add(1, 'days');
      }
      return days;
    }
    else if (initView === this.CONST_VIEWS.oneRowDate){
      return [moment().add(offset, 'days').startOf('day')];
    }
    else if (initView === this.CONST_VIEWS.dayGridMonth){
      const firstDayOfMonth = moment().add(offset, 'months').startOf('month');
      const startingDay = firstDayOfMonth.day();
      const numDaysInMonth = firstDayOfMonth.daysInMonth();
      const days = [];
      let startDate = firstDayOfMonth.clone().subtract(startingDay, 'days');
      let endDate = firstDayOfMonth.clone().add(numDaysInMonth + (6 - startingDay), 'days');
      for (let i = 0; i < 6; i++) {
        for (let j = 0; j < 7; j++) {
          const dateObj = startDate.clone();
          days.push(dateObj);
          startDate.add(1, 'day');
        }
      }
      return days;
    }
    return [];
  }
  getCalendarColumnHeader(date){
    const currentDate = moment(date);
    const initView = this.options.initView;
    let formattedDate = currentDate.format("ddd MM/DD");
    if (initView === this.CONST_VIEWS.dayGridMonth){
      formattedDate = currentDate.format("ddd");
    }
    return formattedDate;
  }
  getCalenderCenter(){
    const days = this.getOffsetDays();
    const initView = this.options.initView;
    let formattedDate = '';
    if (initView === this.CONST_VIEWS.oneRowWeek){
      const startDate = days[0];
      const endDate =  days[days.length - 1];

      if (startDate.year() !== endDate.year()) {
          formattedDate = startDate.format('LL') + "—" + endDate.format("LL");;
      } 
      else {
        if (startDate.month() !== endDate.month())
          formattedDate = startDate.format('LL') + "—" + endDate.format("MMMDo");
        else 
          formattedDate = startDate.format('LL') + "—" + endDate.format("Do");
      }
    }
    else if (initView === this.CONST_VIEWS.oneRowDate){
      formattedDate = days[0].format("LL")
    }
    else if (initView === this.CONST_VIEWS.oneRowMonth || initView === this.CONST_VIEWS.dayGridMonth){
      const start = days[0];
      formattedDate = start.format("MMMM YYYY");
    }
    return formattedDate;
  }
  // render ui calendar
  render(){
    const MFCalendar = this;
    const MFViewsCalendar = MFCalendar.options.views; 
    if (!MFCalendar.calendarElm) return;
    MFCalendar.calendarElm.empty();
    jQuery(MFCalendar.currentPopupDetailEvent).remove();
    // options parameter
    const groupBy = MFCalendar?.options?.groupBy;
    const isAutoGeneratedDate = MFCalendar?.options?.isAutoGeneratedDate;
    if (MFCalendar?.events?.length == 0 && !isAutoGeneratedDate) return;
    MFCalendar.calendarElm.append(`
    
    <div class="d-flex flex-row">
      <div>
        <table id="${MFCalendar.elementId}-groupby-table">
          <thead><tr></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="mf-calendar-container">
        <table id="${MFCalendar.elementId}-table">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>`);
    const tableGroupBy = jQuery(`#${MFCalendar.elementId}-groupby-table`);
    const theadGroupBy = jQuery(`#${MFCalendar.elementId}-groupby-table thead tr`);
    const tbodyGroupBy = jQuery(`#${MFCalendar.elementId}-groupby-table tbody`);
    const table = jQuery(`#${MFCalendar.elementId}-table`);
    const thead = jQuery(`#${MFCalendar.elementId}-table thead`);
    const tbody = jQuery(`#${MFCalendar.elementId}-table tbody`);
    // init view
    tableGroupBy.hide();
    thead.empty();
    tbody.empty();
    theadGroupBy.empty();
    tbodyGroupBy.empty();
    if (!groupBy) return;
    const initView = MFCalendar.options.initView || MFCalendar.CONST_VIEWS.oneRowMonth
    console.log('MFCalendar.options.initView', initView)
    const offset = MFCalendar.options.offset || 0;
    
    const datesArray = isAutoGeneratedDate ? MFCalendar.getOffsetDays() : MFCalendar.datesArray;
    console.log('datesArray', datesArray);
    let countRow = {};
    for (const row of groupBy?.rowData){
      for (const [colIndex, col] of groupBy.colHeader.entries()){
        if (colIndex > 0) continue;
        if (!countRow[row[col]])
          countRow[row[col]] = 1;
        else countRow[row[col]] ++;
      }
    }
    console.log('countRow', countRow)
    if (initView === MFCalendar.CONST_VIEWS.oneRowWeek || initView === MFCalendar.CONST_VIEWS.oneRowMonth){
      console.log('groupBy in calendar', groupBy);
      let headerElm = jQuery(`<tr>`);
      for (const col of groupBy.colHeader){
        headerElm.append(`<th class="group-by-col">${col}</th>`)
      }
      for (const date of datesArray){
        const currentDate = moment(date);
        const thDateElm = jQuery(`<th class="align-top text-left" data-date="${currentDate.format('YYYY-MM-DD')}" data-day="${currentDate.day()}"></th>`); 
        const divContainer = jQuery(`<div class="d-flex flex-column p-1">`);
        if (typeof MFCalendar.renderInfoDate === 'function'){
          divContainer.append(`<div class="date-info-date mb-1">${MFCalendar.renderInfoDate(currentDate)}</div>`);
        }
        else divContainer.append(`<div class="date-info-date mb-1">${currentDate.format('DD')}</div>`);
        divContainer.append(`<div class="date-info-day mb-1">${currentDate.format('ddd')}</div>`);
        divContainer.append(`<div class="date-info-special"></div>`);
        thDateElm.append(divContainer);
        headerElm.append(thDateElm)
      }
      thead.append(headerElm);
      for (const [rowIndex, row] of groupBy?.rowData.entries()){ 
        let elm = `<tr data-groupby-index="${rowIndex}">`;
        for (const [colIndex, col] of groupBy.colHeader.entries()){
          if (colIndex == 0){
            if (countRow[row[col]] > 0) {
              elm += `<td rowspan="${countRow[row[col]]}">${row[col]}</td>`
              countRow[row[col]] = 0;
            }
          }
          else elm += `<td>${row[col]}</td>`
        }
        for (const date of datesArray){
          const eventDate = MFCalendar.events.filter(o => {
            if (moment(o.start).format('YYYY-MM-DD') !== moment(date).format('YYYY-MM-DD')) return false;
            for (const key of Object.keys(row.data)){
              if (o[key] !== row.data[key]) return false;
            }
            return true;
          })
          elm += MFCalendar.renderEventOfDate(date, eventDate);
        }
        elm += `</tr>`;
        tbody.append(elm);
      }
      if (groupBy?.total){
        const totalTr = jQuery(`<tr>`);
        const headerRowTd = jQuery(`<td colspan="2">合計</td>`);
        totalTr.append(headerRowTd);
        tbody.append(totalTr);
        for (const date of datesArray){
          let total = 0;
          for (const event of MFCalendar.events){
            if (moment(event.start).format('YYYY-MM-DD') !== moment(date).format('YYYY-MM-DD')) continue;
            total += (+event[groupBy.total])
          }
          if (total > 0){
            totalTr.append(jQuery(`<td>${total}</td>`))
          }
          else totalTr.append(jQuery(`<td></td>`))
        }
      }
    }
    else if (initView === MFCalendar.CONST_VIEWS.oneRowDate){
      let headerElm = jQuery(`<tr>`);
      for (const col of groupBy.colHeader){
        headerElm.append(`<th class="group-by-col">${col}</th>`)
      }
      for (let hour = 0; hour < 24; hour++) {
        const thHourElm = jQuery(`<th data-date="${datesArray[0].hour(hour).format('YYYY-MM-DD HH:mm')}" colspan="2">`); 
        thHourElm.append(`<div>${moment({ hour }).format('HH:mm')}</div>`)
        headerElm.append(thHourElm)
      }
      thead.append(headerElm);
      
      for (const [rowIndex, row] of groupBy?.rowData.entries()){ 
        let elm = `<tr data-groupby-index="${rowIndex}">`;
        for (const [colIndex, col] of groupBy.colHeader.entries()){
          if (colIndex == 0){
            if (countRow[row[col]] > 0) {
              elm += `<td rowspan="${countRow[row[col]]}">${row[col]}</td>`
              countRow[row[col]] = 0;
            }
          }
          else elm += `<td>${row[col]}</td>`
        }
        const startDate = moment(datesArray[0]).startOf('day');
        for (let hour = 0; hour < 24; hour++) {
          for (let minute = 0; minute < 60; minute += 30) {
              const momentOfDay = startDate.clone().add(hour, 'hours').add(minute, 'minutes');
              const formattedTime = momentOfDay.format('YYYY-MM-DD HH:mm');
              
              const eventDate = MFCalendar.events.filter(o => {
                const minute = moment(o.start).minute(); 
                const blockStartMinute = minute < 30 ? 0 : 30; 
                const blockStartTime = moment(o.start).startOf('hour').minute(blockStartMinute); 
                if (blockStartTime.format('YYYY-MM-DD HH:mm') !== formattedTime) return false;
                for (const key of Object.keys(row.data)){
                  if (o[key] !== row.data[key]) return false;
                }
                return true;
              })
              
              elm += MFCalendar.renderEventOfDate(momentOfDay, eventDate);
          }
        }
        elm += `</tr>`;
        tbody.append(elm);
      }
    }
    else if (initView === MFCalendar.CONST_VIEWS.dayGridMonth){
      for (let i = 0; i < 7; i++) {
          const date = moment().startOf('week').add(i, 'days');
          thead.append(`<th data-day="${date.day()}">${MFCalendar.getCalendarColumnHeader(date)}</th>`);
      }
      let elm = ``;
      for (let i = 0; i < 42; i++){
        const date = datesArray[i];
        if (i % 7 === 0){
          elm = `<tr>`
        }
        const eventDateOfKey = MFCalendar.events.filter(o => moment(o.start).format('YYYY-MM-DD') === moment(date).format('YYYY-MM-DD'))
        elm += MFCalendar.renderEventOfDate('', date, eventDateOfKey);
        if (i % 7 === 6){
          elm += `</tr>`;
          tbody.append(elm);
        }
      }
    }
    jQuery(`#${MFCalendar.elementId} .mf-calendar-date, #${MFCalendar.elementId} th[data-date]`).click(function() {
      MFCalendar.onFocusDate(jQuery(this))
    });
    const today = moment();
    jQuery(`#${MFCalendar.elementId} td[data-date*="${today.format('YYYY-MM-DD')}"]`).addClass('mf-calendar-today-bg');
    
    jQuery(`#${MFCalendar.elementId} td[data-day=0], #${MFCalendar.elementId} td[data-day=6]`).addClass('mf-calendar-holiday-bg');
    // check special holiday
    jQuery(`#${MFCalendar.elementId} td[data-date]`).each(function(index) {
      const dateData = jQuery(this).data("date");
      const holidayName = MFCalendar.isSpecialHoliday(new Date(dateData));
      if (holidayName){
        jQuery(this).addClass('mf-calendar-holiday-bg')
      }
    });
    jQuery(`#${MFCalendar.elementId} th[data-date]`).each(function(index) {
      const dateData = jQuery(this).data("date");
      const holidayName = MFCalendar.isSpecialHoliday(new Date(dateData));
      if (holidayName){
        const elmSpecialHoliday = jQuery(this).find('.date-info-special');
        elmSpecialHoliday.text(holidayName);
        jQuery(this).addClass('mf-calendar-special-holiday-text')
      }
    });
    // check today
    if (MFCalendar?.options?.hightLightToday){
      jQuery(`#${MFCalendar.elementId} th[data-date*="${today.format('YYYY-MM-DD')}"] div.date-info-date`).addClass('mf-calendar-column-header-today');
    }
    // check now
    jQuery(`#${MFCalendar.elementId} th[data-date*="${today.startOf('hour').format('YYYY-MM-DD HH:mm')}"] div`).addClass('mf-calendar-column-header-now');
    // sync height row and column
    jQuery(`#${MFCalendar.elementId}-groupby-table tbody tr`).each(function(index) {
      const groupByCellHeight = jQuery(this).height();
      const calendarCellHeight = jQuery(`#${MFCalendar.elementId}-table tbody tr`).eq(index).height();
      console.log(groupByCellHeight, calendarCellHeight);
      const heightExpected = Math.max(Math.max(groupByCellHeight, calendarCellHeight), 200)
      jQuery(this).height(heightExpected);
      jQuery(`#${MFCalendar.elementId}-table tbody tr`).eq(index).height(heightExpected);
    });
    jQuery('body').on('click', function(event) {
      if (!jQuery(event.target).hasClass('mf-calendar-date')) {
         MFCalendar.onFocusDate(undefined);
      }
    });
    jQuery(`.show-full-display-event`).click(function(event){
      event.stopPropagation();
    })
    jQuery(`#${MFCalendar.elementId}-table div[data-event-id]`).click(function(event){
      event.stopPropagation();
      const eventId = jQuery(this).data("event-id");
      console.log('eventId', eventId)
      MFCalendar.onShowEventDetail(eventId);
    })
    // resize event element when window resize
    function handleResize(){
      if (MFCalendar?.options?.initView === MFCalendar.CONST_VIEWS.oneRowDate){
        let oneMinuteWidth = jQuery(`#${MFCalendar.elementId}-table thead tr th[colspan="2"]`).first().outerWidth() / 60;
        console.log('oneMinuteWidth', oneMinuteWidth);
        jQuery(`#${MFCalendar.elementId}-table div[data-event-id]`).each(function(){
          const eventId = jQuery(this).data("event-id");
          const event = MFCalendar.events.find(o => o.eventId == eventId);
          const durationInMinutes = moment(event.end).diff(moment(event.start), 'minutes');
          const minute = moment(event.start).minute(); 
          const blockStartMinute = minute < 30 ? 0 : 30;
          jQuery(this).css("width", oneMinuteWidth * durationInMinutes);
          const marginLeftMinutes = minute < 30 ? minute : minute - 30;
          jQuery(this).css("margin-left", oneMinuteWidth * marginLeftMinutes)
          jQuery(this).css("display", "inline-block")
        }) 
      }
    }
    jQuery(document).ready(function() {
      handleResize();
    });
    jQuery(window).resize(function() {
      handleResize();
    });
    MFCalendar.afterRender();
  }
} 